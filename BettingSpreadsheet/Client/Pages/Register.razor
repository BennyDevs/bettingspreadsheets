@page "/register"
@namespace BettingSpreadsheet.Shared
@using System.Text.RegularExpressions
@using System.ComponentModel.DataAnnotations
@inject NavigationManager NavigationManager
@inject BettingSpreadsheet.Client.Services.IAuthService AuthService

<div style="max-width: 400px;">
    <h2>Create your account</h2>
    <EditForm Model="user" OnValidSubmit="HandleRegistration" >
        <DataAnnotationsValidator />
        <MudCard Class="mb-4">
            <MudCardContent>
                <MudForm @bind-Errors="@errors">
                    <MudTextField T="string" Label="Email" Required="true" RequiredError="Email is required!" @bind-Value="user.Email"
                                  Validation="@(new EmailAddressAttribute() {ErrorMessage = "The email address is invalid"})" />
                    <MudTextField T="string" Label="Password" HelperText="Choose a strong password" @bind-Value="user.Password"
                                  InputType="InputType.Password"
                                  Validation="@(new Func<string, IEnumerable<string>>(PasswordStrength))" Required="true"
                                  RequiredError="Password is required!" />
                    <MudTextField T="string" Label="Confirm password" HelperText="Confirm your password" @bind-Value="user.ConfirmPassword"
                                  InputType="InputType.Password"
                                  Validation="@(new Func<string, IEnumerable<string>>(PasswordStrength))" Required="true"
                                  RequiredError="Confirm your password!" />
                    <MudTextField T="string" Label="Username" Required="true" RequiredError="Username is required!" @bind-Value="user.Username" />
                    <MudTextField T="string" Label="Bio (optional)" @bind-Value="user.Bio" Class="pb-2" />
                    <MudCheckBox T="bool" Required="true" RequiredError="You must agree to T&C." Class="ml-n2"
                                 Label="I agree to the terms of condition." @bind-Checked="user.IsConfirmed"/>
                </MudForm>
            </MudCardContent>
            <MudCardActions>
                <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Outlined" Color="Color.Secondary" Disabled="@(!user.IsConfirmed)">Register</MudButton>
            </MudCardActions>
        </MudCard>

        <MudExpansionPanels>
            <MudExpansionPanel Text="@($"Show Errors ({errors.Length})")">
                @foreach (var error in errors)
                {
                    <MudText Color="@Color.Error">@error</MudText>
                }
            </MudExpansionPanel>
        </MudExpansionPanels>
    </EditForm>
</div>

@code {
    string[] errors = { };

    UserRegister user = new UserRegister();

    async void HandleRegistration()
    {
        var result = await AuthService.Register(user);

        if (result.Success)
        {
            @*Legg til toast message*@
            NavigationManager.NavigateTo("");
        }
        else
        {
            @*Legg til toast message*@
        }
    }

    private IEnumerable<string> PasswordStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Password is required!";
            yield break;
        }
        if (pw.Length < 8)
            yield return "Password must be at least of length 8";
        if (!Regex.IsMatch(pw, @"[A-Z]"))
            yield return "Password must contain at least one capital letter";
        if (!Regex.IsMatch(pw, @"[a-z]"))
            yield return "Password must contain at least one lowercase letter";
        if (!Regex.IsMatch(pw, @"[0-9]"))
            yield return "Password must contain at least one digit";
    }

    private IEnumerable<string> IsConfirmed(bool confirmed)
    {
        if (!(confirmed))
        {
            yield return "You have to confirm T&C!";
        }
    }
}
